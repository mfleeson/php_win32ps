version: "{branch}.build.{build}"
skip_tags: true

branches:
  only:
    - develop

clone_folder: "${workspaceRoot}"

install:
  ps: |
    echo "Build cache directory ${workspaceRoot}\\build-cache"
    if (-not (Test-Path "${workspaceRoot}\\build-cache")) {
        mkdir "${workspaceRoot}\\build-cache"
    }

    echo "Download PHP 8 binary tools"
    $bname = 'php-sdk-' + $env:BIN_SDK_VER + '.zip'
    if (-not (Test-Path "${workspaceRoot}\\build-cache\\$bname")) {
        Invoke-WebRequest "https://github.com/OSTC/php-sdk-binary-tools/archive/$bname" -OutFile "${workspaceRoot}\\build-cache\\$bname"
    }
    $dname0 = 'php-sdk-binary-tools-php-sdk-' + $env:BIN_SDK_VER
    $dname1 = 'php-sdk-' + $env:BIN_SDK_VER
    if (-not (Test-Path "${workspaceRoot}\\build-cache\\$dname1")) {
        7z x "${workspaceRoot}\\build-cache\\$bname" -o"${workspaceRoot}\\build-cache"
        Start-Sleep -s 5
        move "${workspaceRoot}\\build-cache\\$dname0" "${workspaceRoot}\\build-cache\\$dname1"
    }

    echo "Copy GIT files to SRC build directory"
    xcopy "${workspaceRoot}" "${workspaceRoot}\\php-src\\ext\\php_win32ps\\" /s /e /y /f

cache:
  "${workspaceRoot}\\php_win32ps" -> .appveyor.yml

environment:
  PHP_SDK_PATH: "${workspaceRoot}\\php-8.2.25-devel-vs16-x64"
  BIN_SDK_VER: 2.2.0
  PTHREADS_VER: 2.9.1
  matrix:
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
      ARCH: x64
      VC: vs16
      PHP_VER: 8.2.25
      TS: 1

build_script:
  ps: |
    $ts_part = ''
    if ('0' -eq $env:TS) { $ts_part = '-nts' }
    $bname = 'php-devel-pack-' + $env:PHP_VER + $ts_part + '-Win32-' + $env:VC.toUpper() + '-' + $env:ARCH + '.zip'
    echo "Download PHP8 development pack from release http://windows.php.net/downloads/releases/$bname"
    if (-not (Test-Path "${workspaceRoot}\\build-cache\\$bname")) {
     Invoke-WebRequest "http://windows.php.net/downloads/releases/$bname" -OutFile "${workspaceRoot}\\build-cache\\$bname"
    }

    $dname0 = 'php-' + $env:PHP_VER + '-devel-' + $env:VC.toUpper() + '-' + $env:ARCH
    $dname1 = 'php-' + $env:PHP_VER + $ts_part + '-devel-' + $env:VC.toUpper() + '-' + $env:ARCH
    if (-not (Test-Path "${workspaceRoot}\\build-cache\\$dname1")) {
     7z x "${workspaceRoot}\\build-cache\\$bname" -o"${workspaceRoot}\\build-cache"
    }

    echo "Main build process..."
    cd "${workspaceRoot}"
    $env:PATH = "${workspaceRoot}\\build-cache\\$dname1;" + $env:PATH
    echo "" | Out-File -Encoding "ASCII" task.bat
    echo "call phpize 2>&1" | Out-File -Encoding "ASCII" -Append task.bat
    $conf_cmd = 'call configure --enable-win32ps=shared --enable-debug-pack 2>&1'
    echo $conf_cmd | Out-File -Encoding "ASCII" -Append task.bat
    echo "nmake /nologo 2>&1" | Out-File -Encoding "ASCII" -Append task.bat
    echo "exit %errorlevel%" | Out-File -Encoding "ASCII" -Append task.bat
    $here = (Get-Item -Path "." -Verbose).FullName
    $runner = "${workspaceRoot}\\build-cache\\php-sdk-" + $env:BIN_SDK_VER + "\\phpsdk-" + $env:VC + '-' + $env:ARCH + '.bat'
    $task = $here + '\\task.bat'
    & $runner -t $task

after_build:
  ps: |
    echo "Build download archive of build extension and save as artifact..."
    $ts_part = 'ts'
    if ('0' -eq $env:TS) { $ts_part = '-nts' }
    $zip_bname = 'php_win32ps-' + $env:APPVEYOR_REPO_COMMIT.substring(0, 8) + '-' + $env:PHP_VER.substring(0, 3) + '-' + $ts_part + '-' + $env:VC + '-' + $env:ARCH + '.zip'
    $dir = "${workspaceRoot}\\"
    if ('x64' -eq $env:ARCH) { $dir = $dir + 'x64\\' }
    $dir = $dir + 'Release'
    if ('1' -eq $env:TS) { $dir = $dir + '_TS' }
    & 7z a c:\\$zip_bname $dir\\php_win32ps.dll
    Push-AppveyorArtifact c:\\$zip_bname

test_script:
  ps: |
    echo "Start tests..."
